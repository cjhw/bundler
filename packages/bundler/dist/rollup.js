"use strict";var Y=Object.create;var E=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,re=Object.prototype.hasOwnProperty;var oe=(i,e)=>{for(var t in e)E(i,t,{get:e[t],enumerable:!0})},M=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of ee(e))!re.call(i,o)&&o!==t&&E(i,o,{get:()=>e[o],enumerable:!(r=Z(e,o))||r.enumerable});return i},p=(i,e,t)=>(M(i,e,"default"),t&&M(t,e,"default")),A=(i,e,t)=>(t=i!=null?Y(te(i)):{},M(e||!i||!i.__esModule?E(t,"default",{value:i,enumerable:!0}):t,i)),ie=i=>M(E({},"__esModule",{value:!0}),i);var u=(i,e,t)=>new Promise((r,o)=>{var n=a=>{try{l(t.next(a))}catch(c){o(c)}},s=a=>{try{l(t.throw(a))}catch(c){o(c)}},l=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,s);l((t=t.apply(i,e)).next())});var d={};oe(d,{rollup:()=>pe});module.exports=ie(d);var H=A(require("magic-string"));var P=require("path");var z=A(require("magic-string")),J=require("ast-parser");var f=Object.keys,$=Object.values;var g=class{constructor(e,t,r){this.isFunctionDeclaration=!1;this.name=null;this.isParam=!1;this.isUsed=!1;this.isReassigned=!1;e&&(e.type==="FunctionDeclaration"?(this.isFunctionDeclaration=!0,this.functionNode=e):e.type==="VariableDeclarator"&&e.init&&/FunctionExpression/.test(e.init.type)&&(this.isFunctionDeclaration=!0,this.functionNode=e.init)),this.statement=r,this.isParam=t}addReference(e){e.declaration=this,this.name=e.name}use(){this.isUsed=!0,this.statement&&this.statement.mark()}render(){return this.name}},N=class extends g{constructor(e,t,r){super(e,!1,r),this.original=null,this.exportName="",this.name=t}render(){var e;return((e=this.original)==null?void 0:e.render())||this.name}bind(e){this.original=e}},w=class extends g{constructor(t){super(null,!1,null);this.originals={};this.needsNamespaceBlock=!1;this.module=t,t.getExports().forEach(r=>{let o=t.traceExport(r);o&&(this.originals[r]=o)})}addReference(t){if(this.needsNamespaceBlock||(this.needsNamespaceBlock=!0),t.objectPaths.length){let r=t.objectPaths.shift();t.name=r.name,t.start=r.start,t.end=r.end}$(this.originals).forEach(r=>{r.addReference(t)}),super.addReference(t)}renderBlock(t="  "){let r=f(this.originals).map(o=>{let n=this.originals[o];return`${t}${o}: ${n.render()}`}).join(`,
`);return`const ${this.render()} = Object.freeze({
${r}
});`}use(){for(let t of $(this.originals))t.use()}};var y=class{constructor(e){this.declarations={};let{parent:t,paramNodes:r,block:o,statement:n}=e;this.parent=t,this.paramNodes=r||[],this.statement=n,this.isBlockScope=!!o,this.paramNodes.forEach(s=>this.declarations[s.name]=new g(s,!0,this.statement))}addDeclaration(e,t){if(this.isBlockScope&&!t&&this.parent){this.parent.addDeclaration(e,t);return}let r=e.id&&e.id.name;this.declarations[r]=new g(e,!1,this.statement)}eachDeclaration(e){f(this.declarations).forEach(t=>{e(t,this.declarations[t])})}contains(e){return this.findDeclaration(e)}findDeclaration(e){return this.declarations[e]||this.parent&&this.parent.findDeclaration(e)}};var D=require("ast-parser");function _(i){return i?i.type==="FunctionDeclaration"||i.type===D.NodeType.VariableDeclarator&&i.init&&i.init.type===D.NodeType.FunctionExpression||(i.type===D.NodeType.ExportNamedDeclaration||i.type===D.NodeType.ExportDefaultDeclaration)&&!!i.declaration&&i.declaration.type===D.NodeType.FunctionDeclaration:!1}function T(i){return/^Export/.test(i.type)}function C(i){return i.type==="ImportDeclaration"}var L,b;function I(i,{enter:e,leave:t}){b=!1,V(i,null,e,t)}var ne={skip:()=>L=!0,abort:()=>b=!0},G={},ae=Object.prototype.toString;function se(i){return ae.call(i)==="[object Array]"}function V(i,e,t,r,o){if(!i||b||t&&(L=!1,t.call(ne,i,e,o),L||b))return;let n=G[i.type]||(G[i.type]=Object.keys(i).filter(a=>typeof i[a]=="object")),s,l;for(let a=0;a<n.length;a++)if(s=n[a],l=i[s],se(l))for(let c=0;c<l.length;c++)V(l[c],i,t,r,s);else l&&l.type&&V(l,i,t,r,s);r&&!b&&r(i,e,o)}var S=require("ast-parser");function K(i){let{node:e,scope:t}=i,r=t;I(e,{enter(o){if(o.type===S.NodeType.FunctionDeclaration&&r.addDeclaration(o,!1),o.type===S.NodeType.VariableDeclaration){let s=o,l=s.kind!=="var";s.declarations.forEach(a=>{r.addDeclaration(a,l)})}let n;if(o.type===S.NodeType.FunctionDeclaration){let s=o;n=new y({parent:r,block:!1,paramNodes:s.params,statement:i})}o.type===S.NodeType.BlockStatement&&(n=new y({parent:r,block:!0,statement:i})),n&&(Object.defineProperty(o,"_scope",{value:n,configurable:!0}),r=n)},leave(o){o._scope&&r.parent&&(r=r.parent)}})}var v=class{constructor(e,t,r){this.declaration=null;this.objectPaths=[];this.node=e,this.scope=t,this.statement=r,this.start=e.start,this.end=e.end;let o=e;for(this.objectPaths=[];o.type==="MemberExpression";)this.objectPaths.unshift(o.property),o=o.object;this.objectPaths.unshift(o),this.name=o.name}};function le(i,e){return i.type==="MemberExpression"&&e.type!=="MemberExpression"?!0:i.type==="Identifier"?!(e.type==="ExportSpecifier"&&i!==e.local):!1}function U(i){let{references:e,scope:t,node:r}=i,o=t;I(r,{enter(n,s){if(n._scope&&(o=n._scope),le(n,s)){let l=new v(n,o,i);e.push(l)}},leave(n){n._scope&&o.parent&&(o=o.parent)}})}var B=class{constructor(e,t,r){this.isIncluded=!1;this.defines=new Set;this.modifies=new Set;this.dependsOn=new Set;this.references=[];this.magicString=t,this.node=e,this.module=r,this.scope=new y({statement:this}),this.start=e.start,this.next=0,this.isImportDeclaration=C(e),this.isExportDeclaration=T(e),this.isReexportDeclaration=this.isExportDeclaration&&!!e.source,this.isFunctionDeclaration=_(e)}analyse(){this.isImportDeclaration||(K(this),U(this))}mark(){this.isIncluded||(this.isIncluded=!0,this.references.forEach(e=>e.declaration&&e.declaration.use()))}};var R=class{constructor({path:e,bundle:t,code:r,loader:o,isEntry:n=!1}){this.isEntry=!1;this.exportAllSources=[];this.exportAllModules=[];this.dependencies=[];this.dependencyModules=[];this.referencedModules=[];this.id=e,this.bundle=t,this.moduleLoader=o,this.isEntry=n,this.path=e,this.code=r,this.magicString=new z.default(r),this.imports={},this.exports={},this.reexports={},this.declarations={};try{let l=(0,J.parse)(r).body;this.statements=l.map(a=>{let c=this.magicString.snip(a.start,a.end);return new B(a,c,this)})}catch(s){throw console.log(s),s}this.analyseAST()}analyseAST(){this.statements.forEach(r=>{r.analyse(),r.isImportDeclaration?this.addImports(r):r.isExportDeclaration&&this.addExports(r),r.scope.parent||r.scope.eachDeclaration((o,n)=>{this.declarations[o]=n})});let e=this.statements,t=this.code.length;for(let r=e.length-1;r>=0;r--)e[r].next=t,t=e[r].start}addDependencies(e){this.dependencies.includes(e)||this.dependencies.push(e)}addImports(e){let t=e.node,r=t.source.value;t.specifiers.forEach(o=>{let n=o.type==="ImportDefaultSpecifier",s=o.type==="ImportNamespaceSpecifier",l=o.local.name,a=n?"default":s?"*":o.imported.name;this.imports[l]={source:r,name:a,localName:l}}),this.addDependencies(r)}addExports(e){let t=e.node,r=t.source&&t.source.value;if(t.type==="ExportNamedDeclaration")if(t.specifiers.length)t.specifiers.forEach(o=>{let n=o.local.name,s=o.exported.name;this.exports[s]={localName:n,name:s},r&&(this.reexports[n]={statement:e,source:r,localName:n,name:n,module:void 0},this.imports[n]={source:r,localName:n,name:n},this.addDependencies(r))});else{let o=t.declaration,n;o.type==="VariableDeclaration"?n=o.declarations[0].id.name:n=o.id.name,this.exports[n]={statement:e,localName:n,name:n}}else if(t.type==="ExportDefaultDeclaration"){let o=t.declaration.id&&t.declaration.id.name||t.declaration.name;this.exports.default={statement:e,localName:o,name:"default"},this.declarations.default=new N(t,o,e)}else t.type==="ExportAllDeclaration"&&r&&(this.exportAllSources.push(r),this.addDependencies(r))}bind(){this.bindImportSpecifiers(),this.bindReferences()}bindImportSpecifiers(){[...Object.values(this.imports),...Object.values(this.reexports)].forEach(e=>{e.module=this._getModuleBySource(e.source)}),this.exportAllModules=this.exportAllSources.map(this._getModuleBySource.bind(this)),this.dependencyModules=this.dependencies.map(this._getModuleBySource.bind(this)),this.dependencyModules.forEach(e=>{e.referencedModules.push(this)})}bindReferences(){if(this.declarations.default&&this.exports.default.localName){let e=this.trace(this.exports.default.localName);e&&this.declarations.default.bind(e)}this.statements.forEach(e=>{e.references.forEach(t=>{let r=t.scope.findDeclaration(t.name)||this.trace(t.name);r&&r.addReference(t)})})}getOrCreateNamespace(){return this.declarations["*"]||(this.declarations["*"]=new w(this)),this.declarations["*"]}trace(e){if(this.declarations[e])return this.declarations[e];if(this.imports[e]){let t=this.imports[e],r=t.module;if(t.name==="*")return r.getOrCreateNamespace();let o=r.traceExport(t.name);if(o)return o}return null}traceExport(e){let t=this.reexports[e];if(t){let o=t.module.traceExport(t.localName);if(!o)throw new Error(`${t.localName} is not exported by module ${t.module.path}(imported by ${this.path})`);return o}if(this.exports[e]){let o=this.trace(e);if(o)return o}for(let o of this.exportAllModules){let n=o.trace(e);if(n)return n}return null}render(){let e=this.magicString.clone().trim();if(this.statements.forEach(t=>{if(!t.isIncluded){e.remove(t.start,t.next);return}if(t.references.forEach(r=>{let{start:o,end:n}=r,s=r.declaration;if(s){let l=s.render();e.overwrite(o,n,l)}}),t.isExportDeclaration&&!this.isEntry){if(t.node.type==="ExportNamedDeclaration"&&t.node.specifiers.length)e.remove(t.start,t.next);else if(t.node.type==="ExportNamedDeclaration"&&(t.node.declaration.type==="VariableDeclaration"||t.node.declaration.type==="FunctionDeclaration"))e.remove(t.node.start,t.node.declaration.start);else if(t.node.type==="ExportAllDeclaration")e.remove(t.start,t.next);else if(t.node.type==="ExportDefaultDeclaration"){let o=this.declarations.default.render();t.node.declaration.type==="FunctionDeclaration"?t.node.declaration.id?e.overwrite(t.node.start,t.node.declaration.start,`const ${o} = `):e.overwrite(t.node.start,t.node.declaration.start+8,`function ${o}`):e.overwrite(t.node.start,t.node.declaration.start,`const ${o} = `)}}}),this.declarations["*"]){let t=this.declarations["*"];t.needsNamespaceBlock&&e.append(`

${t.renderBlock()}
`)}return e.trim()}getExports(){return[...f(this.exports),...f(this.reexports),...this.exportAllModules.map(e=>e.getExports().filter(t=>t!=="default")).flat()]}_getModuleBySource(e){let t=this.moduleLoader.resolveId(e,this.path);return this.bundle.getModuleById(t)}};var m=require("path");function W(i,e){return(0,m.isAbsolute)(i)?i:i.startsWith(".")?e?(0,m.resolve)((0,m.dirname)(e),i):(0,m.resolve)(i):!1}var q=require("fs/promises");var k=class{constructor(e){this.resolveIdsMap=new Map;this.bundle=e}resolveId(e,t){let r=e+t;if(this.resolveIdsMap.has(r))return this.resolveIdsMap.get(r);let o=W(e,t);return this.resolveIdsMap.set(r,o),o}fetchModule(s,l){return u(this,arguments,function*(e,t,r=!1,o=this.bundle,n=this){let a=this.resolveId(e,t);if(a===!1)return null;let c=this.bundle.getModuleById(a);if(c)return c;let x=yield(0,q.readFile)(a,{encoding:"utf-8"}),h=new R({path:a,code:x,bundle:o,loader:n,isEntry:r});return this.bundle.addModule(h),yield this.fetchAllDependencies(h),h})}fetchAllDependencies(e){return u(this,null,function*(){yield Promise.all(e.dependencies.map(t=>this.fetchModule(t,e.path)))})}};var O=class{constructor(e){this.statements=[];this.modules=[];this.moduleById={};this.resolveIds={};this.orderedModules=[];let{entry:t,bundle:r}=e;this.entryPath=(0,P.resolve)(t),this.basedir=(0,P.dirname)(this.entryPath),this.bundle=r,this.moduleLoader=new k(r)}build(){return u(this,null,function*(){let e=yield this.moduleLoader.fetchModule(this.entryPath,null,!0);this.modules.forEach(t=>t.bind()),this.orderedModules=this.sortModules(e),e.getExports().forEach(t=>{e.traceExport(t).use()}),this.doconflict()})}doconflict(){let e={};function t(r){let o=r,n=1;for(;e[o];)o=`${r}$${n++}`;return e[o]=!0,o}this.modules.forEach(r=>{f(r.declarations).forEach(o=>{let n=r.declarations[o];n.name=t(n.name)})})}getModuleById(e){return this.moduleById[e]}addModule(e){this.moduleById[e.id]||(this.moduleById[e.id]=e,this.modules.push(e))}sortModules(e){let t=[],r={},o={},n=[];function s(a,c){let x=[a],h=c;for(;h!==a;)x.push(h),h=o[h];return x.push(x[0]),x.reverse()}function l(a){if(!r[a.id]){for(let c of a.dependencyModules){if(o[c.id]){r[c.id]||n.push(s(c.id,a.id));continue}o[c.id]=a.id,l(c)}r[a.id]=!0,t.push(a)}}return l(e),n.length&&(n.forEach(a=>{console.log(a)}),process.exit(1)),t}};var j=class{constructor(e){this.graph=new O({entry:e.entry,bundle:this})}build(){return u(this,null,function*(){yield this.graph.build()})}getModuleById(e){return this.graph.getModuleById(e)}addModule(e){return this.graph.addModule(e)}render(){let e=new H.Bundle({separator:`
`});this.graph.orderedModules.forEach(r=>{e.addSource({content:r.render()})});let t=e.generateMap({includeContent:!0});return{code:e.toString(),map:t}}};var F=A(require("fs")),X=require("path");p(d,require("ast-parser"),module.exports);var ce=i=>F.default.existsSync(i),de=i=>new Promise((e,t)=>{let r=i.substring(0,i.lastIndexOf("/"));F.default.mkdir(r,{recursive:!0},o=>{o?t({success:!1}):e({success:!0})})}),Q=(i,e,t="utf-8")=>new Promise((r,o)=>{F.default.writeFile(i,e,{mode:438,flag:"w+",encoding:t},n=>{n?o({success:!1,data:n}):r({success:!0,data:{path:i,content:e}})})});function pe(i){let{input:e="./index.js",output:t="./dist/index.js"}=i,r=new j({entry:e});return r.build().then(()=>{let o=()=>r.render();return{generate:o,write:()=>u(this,null,function*(){let{code:n,map:s}=o();return ce((0,X.dirname)(t))||(yield de(t)),Promise.all([Q(t,n),Q(t+".map",s.toString())])})}})}0&&(module.exports={rollup,...require("ast-parser")});
