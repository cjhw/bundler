var d=(i,e,t)=>new Promise((r,o)=>{var n=a=>{try{l(t.next(a))}catch(c){o(c)}},s=a=>{try{l(t.throw(a))}catch(c){o(c)}},l=a=>a.done?r(a.value):Promise.resolve(a.value).then(n,s);l((t=t.apply(i,e)).next())});import*as T from"magic-string";import{dirname as X,resolve as Y}from"path";import J from"magic-string";import{parse as W}from"ast-parser";var p=Object.keys,B=Object.values;var f=class{constructor(e,t,r){this.isFunctionDeclaration=!1;this.name=null;this.isParam=!1;this.isUsed=!1;this.isReassigned=!1;e&&(e.type==="FunctionDeclaration"?(this.isFunctionDeclaration=!0,this.functionNode=e):e.type==="VariableDeclarator"&&e.init&&/FunctionExpression/.test(e.init.type)&&(this.isFunctionDeclaration=!0,this.functionNode=e.init)),this.statement=r,this.isParam=t}addReference(e){e.declaration=this,this.name=e.name}use(){this.isUsed=!0,this.statement&&this.statement.mark()}render(){return this.name}},x=class extends f{constructor(e,t,r){super(e,!1,r),this.original=null,this.exportName="",this.name=t}render(){var e;return((e=this.original)==null?void 0:e.render())||this.name}bind(e){this.original=e}},D=class extends f{constructor(t){super(null,!1,null);this.originals={};this.needsNamespaceBlock=!1;this.module=t,t.getExports().forEach(r=>{let o=t.traceExport(r);o&&(this.originals[r]=o)})}addReference(t){if(this.needsNamespaceBlock||(this.needsNamespaceBlock=!0),t.objectPaths.length){let r=t.objectPaths.shift();t.name=r.name,t.start=r.start,t.end=r.end}B(this.originals).forEach(r=>{r.addReference(t)}),super.addReference(t)}renderBlock(t="  "){let r=p(this.originals).map(o=>{let n=this.originals[o];return`${t}${o}: ${n.render()}`}).join(`,
`);return`const ${this.render()} = Object.freeze({
${r}
});`}use(){for(let t of B(this.originals))t.use()}};var h=class{constructor(e){this.declarations={};let{parent:t,paramNodes:r,block:o,statement:n}=e;this.parent=t,this.paramNodes=r||[],this.statement=n,this.isBlockScope=!!o,this.paramNodes.forEach(s=>this.declarations[s.name]=new f(s,!0,this.statement))}addDeclaration(e,t){if(this.isBlockScope&&!t&&this.parent){this.parent.addDeclaration(e,t);return}let r=e.id&&e.id.name;this.declarations[r]=new f(e,!1,this.statement)}eachDeclaration(e){p(this.declarations).forEach(t=>{e(t,this.declarations[t])})}contains(e){return this.findDeclaration(e)}findDeclaration(e){return this.declarations[e]||this.parent&&this.parent.findDeclaration(e)}};import{NodeType as g}from"ast-parser";function P(i){return i?i.type==="FunctionDeclaration"||i.type===g.VariableDeclarator&&i.init&&i.init.type===g.FunctionExpression||(i.type===g.ExportNamedDeclaration||i.type===g.ExportDefaultDeclaration)&&!!i.declaration&&i.declaration.type===g.FunctionDeclaration:!1}function j(i){return/^Export/.test(i.type)}function F(i){return i.type==="ImportDeclaration"}var R,y;function b(i,{enter:e,leave:t}){y=!1,k(i,null,e,t)}var G={skip:()=>R=!0,abort:()=>y=!0},A={},K=Object.prototype.toString;function U(i){return K.call(i)==="[object Array]"}function k(i,e,t,r,o){if(!i||y||t&&(R=!1,t.call(G,i,e,o),R||y))return;let n=A[i.type]||(A[i.type]=Object.keys(i).filter(a=>typeof i[a]=="object")),s,l;for(let a=0;a<n.length;a++)if(s=n[a],l=i[s],U(l))for(let c=0;c<l.length;c++)k(l[c],i,t,r,s);else l&&l.type&&k(l,i,t,r,s);r&&!y&&r(i,e,o)}import{NodeType as S}from"ast-parser";function $(i){let{node:e,scope:t}=i,r=t;b(e,{enter(o){if(o.type===S.FunctionDeclaration&&r.addDeclaration(o,!1),o.type===S.VariableDeclaration){let s=o,l=s.kind!=="var";s.declarations.forEach(a=>{r.addDeclaration(a,l)})}let n;if(o.type===S.FunctionDeclaration){let s=o;n=new h({parent:r,block:!1,paramNodes:s.params,statement:i})}o.type===S.BlockStatement&&(n=new h({parent:r,block:!0,statement:i})),n&&(Object.defineProperty(o,"_scope",{value:n,configurable:!0}),r=n)},leave(o){o._scope&&r.parent&&(r=r.parent)}})}var M=class{constructor(e,t,r){this.declaration=null;this.objectPaths=[];this.node=e,this.scope=t,this.statement=r,this.start=e.start,this.end=e.end;let o=e;for(this.objectPaths=[];o.type==="MemberExpression";)this.objectPaths.unshift(o.property),o=o.object;this.objectPaths.unshift(o),this.name=o.name}};function z(i,e){return i.type==="MemberExpression"&&e.type!=="MemberExpression"?!0:i.type==="Identifier"?!(e.type==="ExportSpecifier"&&i!==e.local):!1}function L(i){let{references:e,scope:t,node:r}=i,o=t;b(r,{enter(n,s){if(n._scope&&(o=n._scope),z(n,s)){let l=new M(n,o,i);e.push(l)}},leave(n){n._scope&&o.parent&&(o=o.parent)}})}var E=class{constructor(e,t,r){this.isIncluded=!1;this.defines=new Set;this.modifies=new Set;this.dependsOn=new Set;this.references=[];this.magicString=t,this.node=e,this.module=r,this.scope=new h({statement:this}),this.start=e.start,this.next=0,this.isImportDeclaration=F(e),this.isExportDeclaration=j(e),this.isReexportDeclaration=this.isExportDeclaration&&!!e.source,this.isFunctionDeclaration=P(e)}analyse(){this.isImportDeclaration||($(this),L(this))}mark(){this.isIncluded||(this.isIncluded=!0,this.references.forEach(e=>e.declaration&&e.declaration.use()))}};var N=class{constructor({path:e,bundle:t,code:r,loader:o,isEntry:n=!1}){this.isEntry=!1;this.exportAllSources=[];this.exportAllModules=[];this.dependencies=[];this.dependencyModules=[];this.referencedModules=[];this.id=e,this.bundle=t,this.moduleLoader=o,this.isEntry=n,this.path=e,this.code=r,this.magicString=new J(r),this.imports={},this.exports={},this.reexports={},this.declarations={};try{let l=W(r).body;this.statements=l.map(a=>{let c=this.magicString.snip(a.start,a.end);return new E(a,c,this)})}catch(s){throw console.log(s),s}this.analyseAST()}analyseAST(){this.statements.forEach(r=>{r.analyse(),r.isImportDeclaration?this.addImports(r):r.isExportDeclaration&&this.addExports(r),r.scope.parent||r.scope.eachDeclaration((o,n)=>{this.declarations[o]=n})});let e=this.statements,t=this.code.length;for(let r=e.length-1;r>=0;r--)e[r].next=t,t=e[r].start}addDependencies(e){this.dependencies.includes(e)||this.dependencies.push(e)}addImports(e){let t=e.node,r=t.source.value;t.specifiers.forEach(o=>{let n=o.type==="ImportDefaultSpecifier",s=o.type==="ImportNamespaceSpecifier",l=o.local.name,a=n?"default":s?"*":o.imported.name;this.imports[l]={source:r,name:a,localName:l}}),this.addDependencies(r)}addExports(e){let t=e.node,r=t.source&&t.source.value;if(t.type==="ExportNamedDeclaration")if(t.specifiers.length)t.specifiers.forEach(o=>{let n=o.local.name,s=o.exported.name;this.exports[s]={localName:n,name:s},r&&(this.reexports[n]={statement:e,source:r,localName:n,name:n,module:void 0},this.imports[n]={source:r,localName:n,name:n},this.addDependencies(r))});else{let o=t.declaration,n;o.type==="VariableDeclaration"?n=o.declarations[0].id.name:n=o.id.name,this.exports[n]={statement:e,localName:n,name:n}}else if(t.type==="ExportDefaultDeclaration"){let o=t.declaration.id&&t.declaration.id.name||t.declaration.name;this.exports.default={statement:e,localName:o,name:"default"},this.declarations.default=new x(t,o,e)}else t.type==="ExportAllDeclaration"&&r&&(this.exportAllSources.push(r),this.addDependencies(r))}bind(){this.bindImportSpecifiers(),this.bindReferences()}bindImportSpecifiers(){[...Object.values(this.imports),...Object.values(this.reexports)].forEach(e=>{e.module=this._getModuleBySource(e.source)}),this.exportAllModules=this.exportAllSources.map(this._getModuleBySource.bind(this)),this.dependencyModules=this.dependencies.map(this._getModuleBySource.bind(this)),this.dependencyModules.forEach(e=>{e.referencedModules.push(this)})}bindReferences(){if(this.declarations.default&&this.exports.default.localName){let e=this.trace(this.exports.default.localName);e&&this.declarations.default.bind(e)}this.statements.forEach(e=>{e.references.forEach(t=>{let r=t.scope.findDeclaration(t.name)||this.trace(t.name);r&&r.addReference(t)})})}getOrCreateNamespace(){return this.declarations["*"]||(this.declarations["*"]=new D(this)),this.declarations["*"]}trace(e){if(this.declarations[e])return this.declarations[e];if(this.imports[e]){let t=this.imports[e],r=t.module;if(t.name==="*")return r.getOrCreateNamespace();let o=r.traceExport(t.name);if(o)return o}return null}traceExport(e){let t=this.reexports[e];if(t){let o=t.module.traceExport(t.localName);if(!o)throw new Error(`${t.localName} is not exported by module ${t.module.path}(imported by ${this.path})`);return o}if(this.exports[e]){let o=this.trace(e);if(o)return o}for(let o of this.exportAllModules){let n=o.trace(e);if(n)return n}return null}render(){let e=this.magicString.clone().trim();if(this.statements.forEach(t=>{if(!t.isIncluded){e.remove(t.start,t.next);return}if(t.references.forEach(r=>{let{start:o,end:n}=r,s=r.declaration;if(s){let l=s.render();e.overwrite(o,n,l)}}),t.isExportDeclaration&&!this.isEntry){if(t.node.type==="ExportNamedDeclaration"&&t.node.specifiers.length)e.remove(t.start,t.next);else if(t.node.type==="ExportNamedDeclaration"&&(t.node.declaration.type==="VariableDeclaration"||t.node.declaration.type==="FunctionDeclaration"))e.remove(t.node.start,t.node.declaration.start);else if(t.node.type==="ExportAllDeclaration")e.remove(t.start,t.next);else if(t.node.type==="ExportDefaultDeclaration"){let o=this.declarations.default.render();t.node.declaration.type==="FunctionDeclaration"?t.node.declaration.id?e.overwrite(t.node.start,t.node.declaration.start,`const ${o} = `):e.overwrite(t.node.start,t.node.declaration.start+8,`function ${o}`):e.overwrite(t.node.start,t.node.declaration.start,`const ${o} = `)}}}),this.declarations["*"]){let t=this.declarations["*"];t.needsNamespaceBlock&&e.append(`

${t.renderBlock()}
`)}return e.trim()}getExports(){return[...p(this.exports),...p(this.reexports),...this.exportAllModules.map(e=>e.getExports().filter(t=>t!=="default")).flat()]}_getModuleBySource(e){let t=this.moduleLoader.resolveId(e,this.path);return this.bundle.getModuleById(t)}};import{dirname as q,isAbsolute as H,resolve as V,extname as Te}from"path";function _(i,e){return H(i)?i:i.startsWith(".")?e?V(q(e),i):V(i):!1}import{readFile as Q}from"fs/promises";var w=class{constructor(e){this.resolveIdsMap=new Map;this.bundle=e}resolveId(e,t){let r=e+t;if(this.resolveIdsMap.has(r))return this.resolveIdsMap.get(r);let o=_(e,t);return this.resolveIdsMap.set(r,o),o}fetchModule(s,l){return d(this,arguments,function*(e,t,r=!1,o=this.bundle,n=this){let a=this.resolveId(e,t);if(a===!1)return null;let c=this.bundle.getModuleById(a);if(c)return c;let m=yield Q(a,{encoding:"utf-8"}),u=new N({path:a,code:m,bundle:o,loader:n,isEntry:r});return this.bundle.addModule(u),yield this.fetchAllDependencies(u),u})}fetchAllDependencies(e){return d(this,null,function*(){yield Promise.all(e.dependencies.map(t=>this.fetchModule(t,e.path)))})}};var I=class{constructor(e){this.statements=[];this.modules=[];this.moduleById={};this.resolveIds={};this.orderedModules=[];let{entry:t,bundle:r}=e;this.entryPath=Y(t),this.basedir=X(this.entryPath),this.bundle=r,this.moduleLoader=new w(r)}build(){return d(this,null,function*(){let e=yield this.moduleLoader.fetchModule(this.entryPath,null,!0);this.modules.forEach(t=>t.bind()),this.orderedModules=this.sortModules(e),e.getExports().forEach(t=>{e.traceExport(t).use()}),this.doconflict()})}doconflict(){let e={};function t(r){let o=r,n=1;for(;e[o];)o=`${r}$${n++}`;return e[o]=!0,o}this.modules.forEach(r=>{p(r.declarations).forEach(o=>{let n=r.declarations[o];n.name=t(n.name)})})}getModuleById(e){return this.moduleById[e]}addModule(e){this.moduleById[e.id]||(this.moduleById[e.id]=e,this.modules.push(e))}sortModules(e){let t=[],r={},o={},n=[];function s(a,c){let m=[a],u=c;for(;u!==a;)m.push(u),u=o[u];return m.push(m[0]),m.reverse()}function l(a){if(!r[a.id]){for(let c of a.dependencyModules){if(o[c.id]){r[c.id]||n.push(s(c.id,a.id));continue}o[c.id]=a.id,l(c)}r[a.id]=!0,t.push(a)}}return l(e),n.length&&(n.forEach(a=>{console.log(a)}),process.exit(1)),t}};var v=class{constructor(e){this.graph=new I({entry:e.entry,bundle:this})}build(){return d(this,null,function*(){yield this.graph.build()})}getModuleById(e){return this.graph.getModuleById(e)}addModule(e){return this.graph.addModule(e)}render(){let e=new T.Bundle({separator:`
`});this.graph.orderedModules.forEach(r=>{e.addSource({content:r.render()})});let t=e.generateMap({includeContent:!0});return{code:e.toString(),map:t}}};import O from"fs";import{dirname as Z}from"path";export*from"ast-parser";var ee=i=>O.existsSync(i),te=i=>new Promise((e,t)=>{let r=i.substring(0,i.lastIndexOf("/"));O.mkdir(r,{recursive:!0},o=>{o?t({success:!1}):e({success:!0})})}),C=(i,e,t="utf-8")=>new Promise((r,o)=>{O.writeFile(i,e,{mode:438,flag:"w+",encoding:t},n=>{n?o({success:!1,data:n}):r({success:!0,data:{path:i,content:e}})})});function it(i){let{input:e="./index.js",output:t="./dist/index.js"}=i,r=new v({entry:e});return r.build().then(()=>{let o=()=>r.render();return{generate:o,write:()=>d(this,null,function*(){let{code:n,map:s}=o();return ee(Z(t))||(yield te(t)),Promise.all([C(t,n),C(t+".map",s.toString())])})}})}export{it as rollup};
